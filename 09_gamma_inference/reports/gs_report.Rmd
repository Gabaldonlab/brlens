---
title: "Gamma inference"
author: "Mois√®s Bernabeu"
# date: "5/10/2022"
output: pdf_document
header-includes: #allows you to add in your own Latex packages
  - \usepackage{float}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 5, message = FALSE,
                      warning = FALSE, error = FALSE, fig.height = 3.3,
                      out.width='60%', fig.align = 'center',
                      fig.pos = 'H',  out.extra = '')

library(knitr)
library(kableExtra)

library(ggplot2)
library(ggpubr)
library(rjags)
library(coda)
library(ggmcmc)
library(tidyr)
library(wesanderson)
library(dplyr)
library(cumstats)
library(latex2exp)

theme_set(theme_bw())

ifile <- '../outputs_up/jags_gaprior_it10K_th3_n1000_un100_s3820.RData'

load(ifile)
source('../scripts/mcmc_funs.R')
```

# Sample
```{r, fig.width=10, out.width='80%', fig.cap='Histogram and density plot.'}
print(ifile)

a <- ggplot() +
  geom_histogram(aes(x = y), alpha = 0.6, col = 'steelblue', fill = 'steelblue')
b <- ggplot() +
  geom_density(aes(x = y), alpha = 0.6, col = 'steelblue', fill = 'steelblue')

ggarrange(a, b, labels = 'auto')
```

# Gibbs parameters
```{r}
odf <- data.frame('alpha' = 2,
                  'beta' = 4,
                  'N sample' = N,
                  'Chains' = nchains,
                  'Thinning' = thin,
                  'Iterations' = niter,
                  'Adaptation' = round(niter / 1000, 0),
                  'Final iter. no' = niter(post),
                  check.names = FALSE)

kbl(odf, booktabs = T) %>%
  kable_styling(latex_options = c('striped', 'hold_position'),
                full_width = F, position = 'center')
```

`a`, `b`, `m`, `mo` and `v` are the $\alpha$ and $\beta$ parameters, the mean, the mode and the variance respectively.

```{r, fig.width=7, fig.height=3.2, out.width='90%', fig.cap='Posterior distributions densities for each parameter and in colors we show the chains.'}
post_list <- mcmc.list(post)
post_df <- as.data.frame(ggs(post_list))
post_df$Chain <- as.factor(post_df$Chain)

ggplot(post_df, aes(x = value, colour = Chain)) +
  geom_density() +
  # geom_point(aes(y = 0), alpha = 0.1) +
  facet_wrap(~Parameter, scales = 'free')
  # scale_color_manual(values = pal)
```

```{r, fig.width=7, fig.height=3.2, out.width='90%', fig.cap='Traceplots for each parameter, in colors we show the chains.'}
ggplot(post_df, aes(x = Iteration, y = value, colour = Chain)) +
  geom_line(size = 0.2) +
  facet_wrap(~Parameter, scales = 'free')
```

```{r}
diagdf <- as.data.frame(ggs_diagnostics(post_df))

summ <- summary(post)

summdf <- cbind(summ$statistics[, 1:2], 'R' = gelman.diag(post)[[1]][, 1],
                'Effective size' = effectiveSize(post))

kbl(round(summdf, 3), booktabs = T, caption = 'Summary statistics of the parameters posterior distributions.') %>%
  kable_styling(latex_options = c('striped', 'hold_position'),
                full_width = F, position = 'center')
```

```{r, fig.width=7, fig.height=6, fig.cap='Autocorrelations vs lag.'}
post_ac <- get_ac_df(post_df, 100)

ggplot(post_ac, aes(x = Lag, y = Autocorrelation, colour = Chain)) +
  geom_line() +
  # xlim(0, 50) +
  facet_grid(Parameter ~ Chain)
```

```{r, fig.width=7, fig.height=6, fig.cap='Estimates of the mean for each parameter and tranformations.'}
post_means <- get_full_means(post_df)
post_running <- get_running(post_df)

ggplot(post_running, aes(x = Iteration, y = rm, colour = as.factor(Chain))) +
  geom_line() +
  # geom_line(aes(y = up), lty = 3, show.legend = FALSE) +
  # geom_line(aes(y = do), lty = 3, show.legend = FALSE) +
  facet_grid(Parameter ~ Chain, scales = 'free') +
  geom_hline(aes(yintercept = m), post_means, lty = 4, size = 0.3) +
  ylab('Running mean') +
  labs(colour = 'Chain')
```

# ML estimation
```{r}
library(MASS)

fitdistr(y, densfun = 'gamma')
```

